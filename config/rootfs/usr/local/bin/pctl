#!/usr/bin/env bash

set -e

function list() {
  playerctl -l 2>/dev/null | sort -u
}

function initialize() {
  if [[ -z "$PLAYER" ]]; then
    if [[ -f "$XDG_RUNTIME_DIR/player" ]]; then
      PLAYER=$(head -1 "$XDG_RUNTIME_DIR/player" | awk '{print $1}')
    else
      PLAYER=$(switchToNext)
    fi

    PLAYER=$(list | awk "/$PLAYER/ {number = NR; print \$0}; NR == 1 {first = \$0}; END {if (length(number) == 0) {print first} }")

    if [[ "$PLAYER" != "$(cat "$XDG_RUNTIME_DIR/player")" ]]; then
      echo "$PLAYER" >"$XDG_RUNTIME_DIR/player"
    fi
  fi

  if ! list 2>/dev/null | grep -q .; then
    fail No players found
  fi
}

function getNext() {
  if [[ "$(list | wc -l)" -gt 1 ]]; then
    PLAYER=$(list | awk "/$PLAYER/ {number = NR+1}; NR == number {print \$0}; NR == 1 {first = \$0}; END {if (length(number) == 0) {print first} else if (number > NR) {print first} }")
  fi
  echo "$PLAYER"
}

function switchToNext() {
  PLAYER="$(getNext | tee "$XDG_RUNTIME_DIR/player")"
  notify-send.sh -h string:x-dunst-stack-tag:player -t 1000 -u normal "$(getUnitDescription "$PLAYER"): $("$0" status)"
  echo "$PLAYER"
}

function swap() {
  pctl -p "$1" play-pause
  pctl -p "$2" play-pause
}

function getPIDFromPlayerctlName() {
  echo "$1" | sed -r 's#^[a-z._-]+([0-9]+)$#\1#g'
}

function getUnitDescription() {
  if [[ "$1" == "youtube-music-desktop-app" ]]; then
    echo "YouTube Music Player"
  elif [[ "$1" =~ ^kdeconnect ]]; then
    echo "Phone"
  else
    getPIDFromPlayerctlName "$1" | xargs -r "$(dirname "$0")/lib/getSystemdUnitDescriptionForPID"
  fi
}

function getUnitName() {
  getPIDFromPlayerctlName "$1" | xargs -r "$(dirname "$0")/lib/getSystemdUnitNameForPID"
}

function fail() {
  echo "$@" >/dev/stderr
  exit 1
}

case "$1" in
  swap)
    swap "$2" "$3"
    ;;
  NEXT)
    initialize
    switchToNext
    ;;
  PRINT)
    if [[ "$2" == -f ]]; then
      "$0" PRINT -i
      (
        set -e
        tail -F "$XDG_RUNTIME_DIR/player" 2>/dev/null &
        pactl subscribe | grep -E --line-buffered "'(new|remove)' on sink-input"
      ) | while read -r _; do
        "$0" PRINT -i
      done
    elif [[ "$2" == -i ]]; then
      if ! "$0" PRINT; then
        "$0" NEXT || true
      fi
    else
      initialize
      getUnitDescription "$PLAYER"
    fi
    ;;
  LIST)
    initialize
    for player in $(list); do
      getUnitDescription "$player"
    done
    ;;
  -s)
    unit="$2"
    shift
    shift
    [[ -z "$unit" ]] && fail Need to provide the unit name
    initialize
    while [[ ! "$(getUnitName "$PLAYER")" =~ $unit(.service)? ]]; do
      PLAYER=$(getNext)
    done
    export PLAYER
    exec "$0" "$@"
    ;;
  volume)
    volume=$2
    [[ -z "$volume" ]] && fail "Need to provide the volume"
    initialize
    unit=$(getUnitName "$PLAYER")
    "$(dirname "$0")/audio_program_volume" -u "$unit" -v "$volume"
    ;;
  *)
    initialize
    exec playerctl -p "$PLAYER" "$@"
    ;;
esac

exit 0
